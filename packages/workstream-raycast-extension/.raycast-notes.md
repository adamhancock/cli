# Workstream Raycast Extension - Development Notes

## Overview

Quick switcher for VS Code windows with real-time metadata including:
- Git branch, sync status, and working directory state
- GitHub PR information and CI check results
- Claude Code session tracking (working/waiting/idle status)
- Live updates via WebSocket connection to daemon

## Prerequisites

### Required

1. **macOS** - Uses `lsof` and AppleScript for window management
2. **Raycast** - Install from https://www.raycast.com/
3. **VS Code** - The extension manages VS Code windows
4. **Node.js 22+** and `pnpm`

### Optional (for full features)

5. **GitHub CLI** (`gh`) - For PR status
   ```bash
   brew install gh
   gh auth login
   ```

6. **Workstream Daemon** - For instant loading and real-time updates
   ```bash
   pnpm add -g @adamhancock/workstream-daemon
   workstream install
   ```

7. **Claude Code Hooks** - For Claude status tracking (see daemon README)

## Setup

### 1. Install Dependencies

```bash
cd packages/workstream-raycast-extension
pnpm install
```

### 2. Icon File

The icon already exists at `assets/window-icon.png` (512x512px PNG).

If you need to regenerate it, use SF Symbols:
1. Open SF Symbols app (pre-installed on macOS)
2. Search for "square.grid.2x2"
3. Export as PNG at 512x512px
4. Save to `assets/window-icon.png`

### 3. Development Mode

```bash
pnpm run dev
```

This opens Raycast in development mode. Changes will hot-reload.

## Testing

### Basic Test (Without Daemon)

1. Open a few VS Code windows with different projects
2. Press Cmd+Space to open Raycast
3. Type "Switch VS Code Window" or "Workstream"
4. Verify you see your VS Code instances listed
5. Select one and press Enter to switch to it

**Expected behavior**:
- First load takes ~2-3 seconds (fetching all metadata)
- Subsequent loads within 30s use cache (~100ms)

### With Daemon (Recommended)

1. Start the daemon:
   ```bash
   workstream status  # Check if running
   workstream start   # Start if not running
   ```

2. Test in Raycast:
   - Every load should be **instant** (< 10ms)
   - Status updates should appear in **real-time**
   - Force refresh with **Cmd+R**

3. Test Claude Code integration:
   - Start a Claude session in a project
   - Send a message → Status should show "Working" (purple)
   - Trigger a plan approval → Status should show "Waiting" (orange)
   - Let Claude finish → Status should show "Idle" (gray)
   - You should receive macOS notifications for waiting/finished events

## Features to Test

### Git Integration
- Branch name displayed
- Ahead/behind counts (e.g., "↑2 ↓1")
- Working directory state (modified, staged, untracked counts)

### PR Integration
- PR number and title
- CI check status (✓ 12/13 passing)
- Different colors for merged (purple), open (green), closed (gray)
- Press Cmd+O to open PR in browser

### Claude Integration
- Bolt icon (⚡) when Claude is active
- Purple "Working" when Claude is processing
- Orange "Waiting" when Claude needs input
- Gray "Idle" when Claude is inactive
- macOS notifications for waiting/finished

### Actions
- **Enter**: Switch to VS Code window
- **Cmd+R**: Force refresh (bypass cache, refetch PR)
- **Cmd+Shift+R**: Clear cache completely
- **Cmd+O**: Open PR in browser
- **Cmd+Shift+F**: Show in Finder
- **Cmd+Shift+C**: Copy workspace path

## Architecture

### Standalone Mode (No Daemon)
```
Raycast Extension → Direct Fetch → Cache (30s TTL)
  ↓
  ├─ lsof (VS Code instances)
  ├─ git commands (status, branch, etc.)
  ├─ gh CLI (PR info, checks)
  └─ ps/lsof (Claude processes)
```

### With Daemon (Recommended)
```
Workstream Daemon (background service, polls every 5s)
  ↓ WebSocket (ws://localhost:58234)
  ↓ Cache (~/.workstream-daemon/instances.json)
  ↓
Raycast Extension (reads cache, < 10ms load time)
```

## Troubleshooting

### Extension doesn't appear in Raycast
- Run `pnpm run dev` again
- Check for build errors in terminal
- Verify icon file exists at `assets/window-icon.png`

### No VS Code instances detected
- Ensure VS Code has folders/workspaces open (not just individual files)
- Check that `lsof` can see VS Code processes: `lsof -c "Code Helper"`

### PR status not showing
- Install GitHub CLI: `brew install gh`
- Authenticate: `gh auth login`
- Verify repo has a GitHub remote: `git remote -v`

### Claude status not updating
- Start the daemon: `workstream start`
- Configure Claude hooks (see daemon README)
- Verify hooks are installed: `cat ~/.claude/settings.json`
- Test hooks manually: `~/.claude/notify-daemon.sh work_started`

### Slow loading
- Install and start the daemon: `workstream install && workstream start`
- Verify daemon is running: `workstream status`
- Check WebSocket connection: `wscat -c ws://localhost:58234`

## Files Modified During Development

- `src/index.tsx` - Main Raycast command component
- `src/utils/daemon-client.ts` - WebSocket client for daemon
- `src/utils/vscode.ts` - VS Code instance detection
- `src/utils/git.ts` - Git status gathering
- `src/utils/github.ts` - GitHub PR fetching
- `src/utils/claude.ts` - Claude Code detection

## Building for Production

```bash
pnpm run build
```

Output is in `dist/` directory.

## Publishing to Raycast Store

```bash
pnpm run publish
```

This uses `@raycast/api` publish command. You'll need Raycast Store access.

## Notes

- This extension is designed to work standalone OR with the daemon
- Daemon provides instant loading but is optional
- All data stays local (git, GitHub, Claude)
- No external services or analytics
- Cache is stored in Raycast's cache directory
